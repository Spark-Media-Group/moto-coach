<!DOCTYPE html>
<html lang="en-AU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - Moto Coach</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700;900&family=Oswald:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- Header -->
    <header class="main-header universal-header">
        <nav class="navbar">
            <div class="logo">
                <img src="images/long logo.png" alt="Moto Coach" class="logo-img">
            </div>
            <div class="nav-right">
                <ul class="nav-links">
                    <li><a href="index.html">Home</a></li>
                    <li class="dropdown">
                        <span class="dropdown-toggle">Programs</span>
                        <ul class="dropdown-menu">
                            <li><a href="programs/professional_coaching.html">Professional Coaching</a></li>
                            <li><a href="programs/us_travel_program.html">US Travel & Training Program</a></li>
                            <!-- <li><a href="programs/australia_travel_program.html">Australia Outback & Experience</a></li> -->
                        </ul>
                    </li>
                    <li><a href="index.html#about">About</a></li>
                    <li><a href="calendar.html">Schedule</a></li>
                    <li><a href="shop.html">Shop</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
                <div class="social-icons">
                    <a href="https://www.instagram.com/sydneymotocoach/" target="_blank" class="social-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.40s-.644-1.44-1.439-1.40z"/>
                        </svg>
                    </a>
                    <a href="https://www.facebook.com/TheMotocoach/" target="_blank" class="social-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                    </a>
                </div>
                <button class="mobile-menu-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </nav>
    </header>

    <main>
        <!-- Calendar Title Section -->
        <section class="calendar-hero">
            <div class="container">
                <h1>Our Schedule</h1>
                <p>Stay up to date with all our training sessions, events, and programs. Book your spot and never miss a session!</p>
            </div>
        </section>

        <!-- Calendar Section -->
        <section class="calendar-section">
            <div class="container">
                <div class="calendar-wrapper">
                    <!-- Calendar Header -->
                    <div class="calendar-header">
                        <button class="nav-btn" id="prevMonth">&lt;</button>
                        <div class="month-year">
                            <h2 id="currentMonth">August 2025</h2>
                        </div>
                        <button class="nav-btn" id="nextMonth">&gt;</button>
                    </div>
                    
                    <!-- Calendar Grid -->
                    <div class="calendar-grid">
                        <!-- Day Headers -->
                        <div class="day-header">Sun</div>
                        <div class="day-header">Mon</div>
                        <div class="day-header">Tue</div>
                        <div class="day-header">Wed</div>
                        <div class="day-header">Thu</div>
                        <div class="day-header">Fri</div>
                        <div class="day-header">Sat</div>
                        
                        <!-- Calendar Days will be inserted here by JavaScript -->
                        <div class="calendar-days" id="calendarDays">
                            <!-- Days will be generated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Event Details Panel -->
                    <div class="event-panel" id="eventPanel">
                        <h3>Training Sessions & Events</h3>
                        <div class="event-list" id="eventList">
                            <p class="no-events">Select a date to view scheduled events</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 Moto Coach.</p>
            <div class="footer-social-icons">
                <a href="https://www.instagram.com/sydneymotocoach/" target="_blank" class="social-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.40s-.644-1.44-1.439-1.40z"/>
                    </svg>
                </a>
                <a href="https://www.facebook.com/TheMotocoach/" target="_blank" class="social-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                    </svg>
                </a>
            </div>
        </div>
    </footer>

    <script src="scripts/main.js"></script>
    <script>
        class MotoCoachCalendar {
            constructor() {
                this.currentDate = new Date();
                this.selectedDate = null;
                this.events = [];
                this.monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                this.init();
            }

            async init() {
                this.bindEvents();
                await this.loadEvents();
                this.renderCalendar();
                this.updateEventPanel();
            }

            bindEvents() {
                const prevBtn = document.getElementById('prevMonth');
                const nextBtn = document.getElementById('nextMonth');

                if (prevBtn) {
                    prevBtn.addEventListener('click', () => this.previousMonth());
                }
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => this.nextMonth());
                }
            }

            async loadEvents() {
                try {
                    // Calculate date range (3 months back to 6 months forward)
                    const startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 3);
                    const endDate = new Date();
                    endDate.setMonth(endDate.getMonth() + 6);

                    const timeMin = startDate.toISOString();
                    const timeMax = endDate.toISOString();

                    // Call our Vercel API endpoint
                    const response = await fetch(`/api/calendar?timeMin=${encodeURIComponent(timeMin)}&timeMax=${encodeURIComponent(timeMax)}&maxResults=50`);
                    
                    if (!response.ok) {
                        throw new Error(`API error: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.fallback) {
                        console.log('API returned fallback, no events to display');
                        this.events = [];
                    } else {
                        // Convert Google Calendar events to our format
                        this.events = this.convertGoogleEvents(data.events || []);
                        console.log(`Loaded ${this.events.length} events from Google Calendar`);
                    }
                    
                } catch (error) {
                    console.error('Error loading calendar events:', error);
                    console.log('No events to display');
                    this.events = [];
                }
            }

            convertGoogleEvents(googleEvents) {
                return googleEvents.map(event => {
                    let eventDate;
                    let timeString = 'All Day';

                    if (event.start.dateTime) {
                        eventDate = new Date(event.start.dateTime);
                        const startTime = this.formatTime(eventDate);
                        
                        if (event.end.dateTime) {
                            const endDate = new Date(event.end.dateTime);
                            const endTime = this.formatTime(endDate);
                            timeString = `${startTime} - ${endTime}`;
                        } else {
                            timeString = startTime;
                        }
                    } else if (event.start.date) {
                        eventDate = new Date(event.start.date);
                        timeString = 'All Day';
                    }

                    return {
                        date: eventDate,
                        time: timeString,
                        title: event.summary || 'Untitled Event',
                        description: event.description || '',
                        location: event.location || '',
                        type: this.categorizeEvent(event.summary || '')
                    };
                }).filter(event => event.date);
            }

            categorizeEvent(title) {
                const titleLower = title.toLowerCase();
                
                if (titleLower.includes('coaching') || titleLower.includes('lesson')) {
                    return 'coaching';
                } else if (titleLower.includes('training') || titleLower.includes('practice')) {
                    return 'training';
                } else if (titleLower.includes('group') || titleLower.includes('session')) {
                    return 'group';
                } else if (titleLower.includes('info') || titleLower.includes('meeting')) {
                    return 'info';
                } else if (titleLower.includes('track') || titleLower.includes('open')) {
                    return 'open';
                } else {
                    return 'event';
                }
            }

            formatTime(date) {
                return date.toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                });
            }

            async previousMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                await this.checkAndLoadEvents();
                this.renderCalendar();
                this.updateEventPanel();
            }

            async nextMonth() {
                this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                await this.checkAndLoadEvents();
                this.renderCalendar();
                this.updateEventPanel();
            }

            async checkAndLoadEvents() {
                const hasEventsForMonth = this.events.some(event => 
                    event.date.getMonth() === this.currentDate.getMonth() && 
                    event.date.getFullYear() === this.currentDate.getFullYear()
                );

                if (!hasEventsForMonth) {
                    await this.loadEvents();
                }
            }

            renderCalendar() {
                const monthElement = document.getElementById('currentMonth');
                const daysContainer = document.getElementById('calendarDays');

                if (!monthElement || !daysContainer) return;

                const monthYear = `${this.monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;
                monthElement.textContent = monthYear;

                daysContainer.innerHTML = '';

                const firstDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), 1);
                const lastDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startingDayOfWeek = firstDay.getDay();

                // Previous month's trailing days
                const prevMonth = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 0);
                for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                    const dayElement = this.createDayElement(prevMonth.getDate() - i, true);
                    daysContainer.appendChild(dayElement);
                }

                // Current month's days
                for (let day = 1; day <= daysInMonth; day++) {
                    const dayElement = this.createDayElement(day, false);
                    daysContainer.appendChild(dayElement);
                }

                // Next month's leading days
                const totalCells = daysContainer.children.length;
                const remainingCells = 42 - totalCells;
                for (let day = 1; day <= remainingCells; day++) {
                    const dayElement = this.createDayElement(day, true);
                    daysContainer.appendChild(dayElement);
                }
            }

            createDayElement(day, isOtherMonth) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // Create day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);

                if (isOtherMonth) {
                    dayElement.classList.add('other-month');
                } else {
                    const today = new Date();
                    const currentDay = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth(), day);
                    
                    if (this.isSameDay(currentDay, today)) {
                        dayElement.classList.add('today');
                    }

                    const dayEvents = this.getEventsForDate(currentDay);
                    if (dayEvents.length > 0) {
                        dayElement.classList.add('has-events');
                        
                        // Add event previews directly in the calendar day
                        const eventsContainer = document.createElement('div');
                        eventsContainer.className = 'day-events';
                        
                        // Show up to 3 events in the day box
                        dayEvents.slice(0, 3).forEach(event => {
                            const eventPreview = document.createElement('div');
                            eventPreview.className = `event-preview event-${event.type}`;
                            
                            // Create event content with title/time and location
                            const eventTitle = event.title.length > 15 
                                ? event.title.substring(0, 15) + '...' 
                                : event.title;
                            
                            const eventTime = event.time === 'All Day' ? 'All Day' : event.time;
                            
                            let eventContent = `
                                <div class="event-header">
                                    <span class="event-name">${eventTitle}</span>
                                    <span class="event-time-small">${eventTime}</span>
                                </div>
                            `;
                            
                            if (event.location) {
                                const eventLocation = event.location.length > 20 
                                    ? event.location.substring(0, 20) + '...' 
                                    : event.location;
                                eventContent += `<div class="event-location-small">📍 ${eventLocation}</div>`;
                            }
                            
                            eventPreview.innerHTML = eventContent;
                            eventsContainer.appendChild(eventPreview);
                        });
                        
                        // If more than 3 events, show "and X more"
                        if (dayEvents.length > 3) {
                            const moreEvents = document.createElement('div');
                            moreEvents.className = 'more-events';
                            moreEvents.textContent = `+${dayEvents.length - 3} more`;
                            eventsContainer.appendChild(moreEvents);
                        }
                        
                        dayElement.appendChild(eventsContainer);
                    }

                    dayElement.addEventListener('click', () => {
                        this.selectDate(currentDay);
                    });
                }

                return dayElement;
            }

            selectDate(date) {
                const previousSelected = document.querySelector('.calendar-day.selected');
                if (previousSelected) {
                    previousSelected.classList.remove('selected');
                }

                const dayElements = document.querySelectorAll('.calendar-day:not(.other-month)');
                dayElements.forEach(element => {
                    if (parseInt(element.textContent) === date.getDate()) {
                        element.classList.add('selected');
                    }
                });

                this.selectedDate = date;
                this.updateEventPanel();
            }

            updateEventPanel() {
                const eventList = document.getElementById('eventList');
                if (!eventList) return;

                if (this.selectedDate) {
                    const dayEvents = this.getEventsForDate(this.selectedDate);
                    
                    if (dayEvents.length > 0) {
                        eventList.innerHTML = dayEvents.map(event => this.createEventHTML(event)).join('');
                    } else {
                        eventList.innerHTML = '<p class="no-events">No events scheduled for this date</p>';
                    }
                } else {
                    const monthEvents = this.getEventsForMonth(this.currentDate);
                    if (monthEvents.length > 0) {
                        eventList.innerHTML = `
                            <p style="color: #ff6b35; font-weight: 600; margin-bottom: 1rem;">
                                Upcoming events this month:
                            </p>
                            ${monthEvents.slice(0, 5).map(event => this.createEventHTML(event, true)).join('')}
                        `;
                    } else {
                        eventList.innerHTML = '<p class="no-events">No events scheduled this month</p>';
                    }
                }
            }

            createEventHTML(event, showDate = false) {
                const dateStr = showDate ? `${event.date.getDate()}/${event.date.getMonth() + 1} - ` : '';
                const locationStr = event.location ? `<div class="event-location">📍 ${event.location}</div>` : '';
                const descriptionStr = event.description ? `<div class="event-description">${event.description}</div>` : '';
                
                return `
                    <div class="event-item">
                        <div class="event-time">${dateStr}${event.time}</div>
                        <div class="event-title">${event.title}</div>
                        ${locationStr}
                        ${descriptionStr}
                    </div>
                `;
            }

            getEventsForDate(date) {
                return this.events.filter(event => this.isSameDay(event.date, date));
            }

            getEventsForMonth(date) {
                return this.events.filter(event => 
                    event.date.getMonth() === date.getMonth() && 
                    event.date.getFullYear() === date.getFullYear()
                ).sort((a, b) => a.date - b.date);
            }

            isSameDay(date1, date2) {
                return date1.getDate() === date2.getDate() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getFullYear() === date2.getFullYear();
            }
        }

        // Initialize calendar when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            if (document.getElementById('calendarDays')) {
                new MotoCoachCalendar();
            }
        });
    </script>
</body>
</html>